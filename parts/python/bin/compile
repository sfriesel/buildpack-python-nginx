#!/bin/bash
set -e
set -o pipefail
set -x

readonly BUILDDIR=$1
readonly CACHEDIR=$2

cd "$BUILDDIR"
if [[ $($CACHEDIR/Python-2.7.9-installed --version) != "Python 2.7.9" ]]; then
	SOURCE_TARBALL='http://python.org/ftp/python/2.7.9/Python-2.7.9.tgz'
	rm -rf $CACHEDIR/*
	mkdir $2/Python-2.7.9-src
	mkdir $2/Python-2.7.9-installed
	curl -L "$SOURCE_TARBALL" | tar -xz --strip-components=1 -C $CACHEDIR/Python-2.7.9-src
	cd $CACHEDIR/Python-2.7.9-src
	./configure --prefix=$CACHEDIR/Python-2.7.9-installed
	make
	make install
	rm -rf $CACHEDIR/Python-2.7.9-src
	cd $BUILDDIR
	mkdir -p .python
fi
cp -rT $CACHEDIR/Python-2.7.9-installed .python
.python/bin/python -m ensurepip
.python/bin/pip install -r requirements.txt

mkdir -p .profile.d
cat > .profile.d/python-path.sh <<'EOF'
APPDIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )/.." && pwd )
export PATH="$APPDIR/.python/bin:$PATH"
sed -i '1 s|^#!.*/.python/bin/python|#!'$APPDIR'/.python/bin/python|' $APPDIR/.python/bin/*
EOF
